<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create TRC</title>
    <script>
        const refreshToken = 'PASTE_HERE';
        const clientId = 'PASTE_HERE';
        const clientSecret = 'PASTE_HERE';

        const folderId = 'PASTE_HERE'; // Your constant folder ID

        async function getAccessToken() {
            try {
                const response = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        client_id: clientId,
                        client_secret: clientSecret,
                        refresh_token: refreshToken,
                        grant_type: 'refresh_token'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to refresh access token');
                }

                const data = await response.json();
                return data.access_token;
            } catch (error) {
                console.error('Error getting access token:', error);
            }
        }

        async function createTRC() {
            const urlParams = new URLSearchParams(window.location.search);
            const productTitle = urlParams.get('productTitle');
            const caseNumber = urlParams.get('caseNumber');
            const sheetID = urlParams.get('sheetID');

            if (!productTitle || !caseNumber || !sheetID) {
                console.error('Required parameters not found.');
                return;
            }

            console.log('Product Title:', productTitle);
            console.log('Case Number:', caseNumber);
            console.log('Sheet ID:', sheetID);

            // Avoid "-" since causes conflict when renaming with GsheetOrganizer.js script
            const newSheetName = `${productTitle} ${caseNumber}`; 

            try {
                const accessToken = await getAccessToken();
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${sheetID}/copy`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: newSheetName,
                        parents: [folderId]
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to copy the Google Sheet');
                }

                const result = await response.json();
                const newSheetId = result.id;
                console.log('New Sheet ID:', newSheetId);

                // Open the new sheet in the same tab
                const newSheetUrl = `https://docs.google.com/spreadsheets/d/${newSheetId}/edit`;
                window.location.href = newSheetUrl;
            } catch (error) {
                console.error('Error creating TRC:', error);
            }
        }

        window.onload = createTRC;
    </script>
</head>
<body>
    <h1>Creating TRC...</h1>
</body>
</html>